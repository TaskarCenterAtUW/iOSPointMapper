//
//  SegmentationModelRequestProcessor.swift
//  IOSAccessAssessment
//
//  Created by Himanshu on 5/5/25.
//
import CoreML
import Vision

/**
    A struct to handle the segmentation model request processing.
    Processes the segmentation model request and returns the segmentation mask as well as the segmented indices.
 */
struct SegmentationModelRequestProcessor {
    var visionModel: VNCoreMLModel
    
    var selectionClasses: [Int] = []
    
    init(selectionClasses: [Int]) {
        let modelURL = Bundle.main.url(forResource: "bisenetv2_35_640_640", withExtension: "mlmodelc")
        let configuration: MLModelConfiguration = MLModelConfiguration()
        configuration.computeUnits = .cpuAndNeuralEngine
        guard let visionModel = try? VNCoreMLModel(for: MLModel(contentsOf: modelURL!, configuration: configuration)) else {
            fatalError("Cannot load CNN model")
        }
        self.visionModel = visionModel
        self.selectionClasses = selectionClasses
    }
    
    mutating func setSelectionClasses(_ classes: [Int]) {
        self.selectionClasses = classes
    }
    
    private func configureSegmentationRequest(request: VNCoreMLRequest) {
        // TODO: Need to check on the ideal options for this
        request.imageCropAndScaleOption = .scaleFill
    }
    
    // MARK: Currently we are relying on the synchronous nature of the request handler
    // Need to check if this is always guaranteed.
    func processSegmentationRequest(with cIImage: CIImage, orientation: CGImagePropertyOrientation = .up)
    -> (segmentationImage: CIImage, segmentedIndices: [Int])? {
        do {
            let segmentationRequest = VNCoreMLRequest(model: self.visionModel)
            self.configureSegmentationRequest(request: segmentationRequest)
            let segmentationRequestHandler = VNImageRequestHandler(
                ciImage: cIImage,
                orientation: orientation,
                options: [:])
            try segmentationRequestHandler.perform([segmentationRequest])
            
            guard let segmentationResult = segmentationRequest.results as? [VNPixelBufferObservation] else {return nil}
            let segmentationBuffer = segmentationResult.first?.pixelBuffer
            
            let uniqueGrayScaleValues = CVPixelBufferUtils.extractUniqueGrayscaleValues(from: segmentationBuffer!)
            let grayscaleValuesToIndex = Constants.SelectedSegmentationConfig.labelToIndexMap
            let selectedIndices = uniqueGrayScaleValues.compactMap { grayscaleValuesToIndex[$0] }
            let selectedIndicesSet = Set(selectedIndices)
            let segmentedIndices = self.selectionClasses.filter{ selectedIndicesSet.contains($0) }
            
            let segmentationImage = CIImage(cvPixelBuffer: segmentationBuffer!)
            
            return (segmentationImage: segmentationImage, segmentedIndices: segmentedIndices)
        } catch {
            print("Error processing segmentation request: \(error)")
        }
        return nil
    }
}
